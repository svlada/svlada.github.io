<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Ajax requests, Curl and Symfony 2</title>
    <meta name="Description" content="This is introductory RequireJS tutorial in RequireJs series.">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="svlada">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">svlada</a></h1>
      <ul class="nav"><li class="nav-item"><a href="/">Home</a></li><li class="nav-item"><a href="/posts/">Archive</a></li><li class="nav-item"><a href="/about/">About</a></li></ul>
    </header>

    <main class="tmpl-post">
      <h1>Proxy Ajax requests, Curl and Symfony 2</h1>

<p>In this article I will explain, how to make cross-domain requests through the proxy using Curl and Symfony 2.</p>
<p>Jump to the <a href="#source-code">#source-code</a> and skip following errata on how to proxy Ajax requests.</p>
<p>Usual scenario looks like this:</p>
<ol>
<li>Client send ajax request to server</li>
<li>Your server forwards request to external/remote server</li>
<li>Waiting on response from remote server</li>
<li>Parse and process response from remote server</li>
<li>Send response back to client</li>
</ol>
<p>First we shall check if client request is XmlHttpRequest using Symfony 2 built in method</p>
<pre><code> $request-&gt;isXmlHttpRequest()
</code></pre>
<h3 id="step-1%3A-client-code">STEP 1: Client code <a class="direct-link" href="#step-1%3A-client-code" aria-hidden="true">#</a></h3>
<p>Client code is quite simple.</p>
<p>You need to craft Ajax request in following way.</p>
<ol>
<li>Specify rest url on your server for handling cross-domain ajax requests.<code>url: &quot;&quot;</code></li>
<li>Wrap request data</li>
</ol>
<p>We need some data in order to create curl request on server-side.</p>
<p>For this example you need to send object with following properties to your server.</p>
<pre><code>     restUrl: &quot;external-api-url&quot;, // Your target url on remote server
     method: &quot;POST&quot;, // Type of request you want to issue to remote server
     params: { 
         action: &quot;getFriendsList&quot; // Parameters you are sending to remote server
     }
</code></pre>
<h3 id="step-2%3A-forward-request-to-remote-server">STEP 2: Forward request to remote server <a class="direct-link" href="#step-2%3A-forward-request-to-remote-server" aria-hidden="true">#</a></h3>
<p>This step is bit tricky.</p>
<p>Client request is arrived to your server-side code. First you need to parse and validate request data.</p>
<p>To repeat once more ... you'll need the following data on server:</p>
<pre><code>&lt;?php
 $restUrl = $request-&gt;request-&gt;get('restUrl'); // Your target url on remote server
 $method = $request-&gt;request-&gt;get('method'); // Type of request you want to issue to remote server
 $params = $request-&gt;request-&gt;get('params'); // Parameters you are sending to remote server
 $contentType = $request-&gt;request-&gt;get('contentType'); // Content-type
 ?&gt;
</code></pre>
<p>You need to create curl request and set parameters you have recieved from client.</p>
<pre><code> &lt;?php
     // Initialize curl handle
     $ch = curl_init(); 
     
     // Set request url
     curl_setopt($ch, CURLOPT_URL, $restUrl); 
     
     // TRUE to include the header in the output.
     curl_setopt($ch, CURLOPT_HEADER, true); 
     
     // A custom request method to use instead of &quot;GET&quot; or &quot;HEAD&quot; when doing a HTTP request.  
     curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method); 
     if ($params != null) {
         // The full data to post in a HTTP &quot;POST&quot; operation.
         curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
     }
     curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
     curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
 ?&gt;
</code></pre>
<p>I strongly suggest to read php manual in order to get familiar with the curl configuration: <a href="http://php.net/manual/en/function.curl-setopt.php">http://php.net/manual/en/function.curl-setopt.php</a></p>
<p>You have enough data to send request to remote server. After executing curl handle, response from remote server is stored in $response variable.</p>
<pre><code>&lt;?php
     $response = curl_exec($ch);
     curl_close($ch);
 ?&gt;
</code></pre>
<p>You have basic setup. Now we are going to add cookie support to our ajax proxy.</p>
<p>Why do we need cookies?</p>
<p>Recently I needed to integrate symfony 2 application with wordpress portal. Authentication is done on Wordpress side, and symfony application is using wordpress cookies to authorize users for accessing protected features.</p>
<p>In production both applications share same domain, but in test enviorment there is a lot of mess (different domains, ports etc).</p>
<p>Where is problem?</p>
<p>Application written in Symfony 2 need to consume some protected backend functionalities on Wordpress side. There is a lot personalized data that is fetched via ajax calls, and this is reason why we need cookies.</p>
<h3 id="how-to-get-cookies-from-symfony2-request-and-set-mutplie-cookies-to-curl%3F">How to get cookies from Symfony2 request and set mutplie cookies to Curl? <a class="direct-link" href="#how-to-get-cookies-from-symfony2-request-and-set-mutplie-cookies-to-curl%3F" aria-hidden="true">#</a></h3>
<p>We need to extract multiple cookies from Symfony 2 request object and set them to curl handle.</p>
<pre><code>&lt;?php
     // Get all cookies from Symfony request object
     $requestCookies = $request-&gt;cookies-&gt;all(); 
     
     // Prepare and set multiple cookies to curl handle
     $cookieArray = array();
     foreach ($requestCookies as $cookieName =&gt; $cookieValue) {
         $cookieArray[] = &quot;{$cookieName}={$cookieValue}&quot;;
     }
 
     // Be sure to set whitespace after '; ' when creating cookie string
     $cookie_string = implode('; ', $cookieArray);
     curl_setopt($ch, CURLOPT_COOKIE, $cookie_string);
?&gt;
</code></pre>
<h3 id="how-to-get-cookies-curl-response-and-set-multiple-cookies-to-symfony-response%3F">How to get cookies Curl response and set multiple cookies to Symfony response? <a class="direct-link" href="#how-to-get-cookies-curl-response-and-set-multiple-cookies-to-symfony-response%3F" aria-hidden="true">#</a></h3>
<p>Remmember when we configured curl with CURLOPT_HEADER=true? Now we are going to parse cookies from curl http response.</p>
<pre><code>&lt;?php    
     // Get header and response data from curl response
     list($headers, $response) = explode(&quot;\r\n\r\n&quot;,$response,2);
     // We are using regex to parse cookies from curl response
     preg_match_all('/Set-Cookie: (.*)\b/', $headers, $cookies);
     // Store cookies
     $cookies = $cookies[1];
?&gt;
</code></pre>
<p>Raw cookies are parsed and stored in cookie array. Then each cookie need to be converted to Symfony Cookie object and injected to Symfony response headers.</p>
<pre><code>&lt;?php
     foreach($cookies as $rawCookie) {
         $cookie = \Symfony\Component\BrowserKit\Cookie::fromString($rawCookie);
         $value = $cookie-&gt;getValue();
         if (!empty($value)) {
             $value = str_replace(' ', '+', $value);
         }
         $customCookie = new Cookie($cookie-&gt;getName(), $value, $cookie-&gt;getExpiresTime()==null?0:$cookie-&gt;getExpiresTime(), $cookie-&gt;getPath());
         $response-&gt;headers-&gt;setCookie($customCookie);
     }
 ?&gt;
</code></pre>
<p><strong>FINAL NOTICE:</strong></p>
<p>Close and store session data before initializing curl handle or you can run into deadlock.</p>
<pre><code>&lt;?php
     session_write_close();
     $ch = curl_init();
?&gt;
</code></pre>
<p>What could happen if you forgot to close session?</p>
<p>Here is one scenario:</p>
<p>PHP script S1 create/sends curl POST request to script S2 on same Apache server/PHP Enviorment. If page S1 and S2 share same session, script S2 will not start executing until end of script S1 lifetime. But script S1 is waiting on response from script S2. This is point where deadlock happen. The default session handler locks the session file for the duration of the page request.</p>
<p><a id="source-code" name="source-code">Complete source code listing for ajax proxy</a></p>
<p><strong>Client sample code</strong></p>
<pre><code> function sendAjaxRequest(){
     $.ajax({
         type: &quot;POST&quot;,
         dataType: 'json',
         url: &quot;&quot;,
         data: {
         	restUrl : &quot;/external-api-url/&quot;,
         	method: 'POST',
             params: {
             	action: &quot;getFriendList&quot;
             }
         },
         success: function(data, textStatus, jqXHR) {
             ...
 		}
 	});
 }
</code></pre>
<p><strong>Server proxy code</strong></p>
<pre><code>&lt;?php
namespace Proxy\Bundle\ProxyBundle\Controller;
 
 use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;
 use Symfony\Bundle\FrameworkBundle\Controller\Controller;
 use Sensio\Bundle\FrameworkExtraBundle\Configuration\Method;
 use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
 use Symfony\Component\HttpFoundation\Response;
 use Symfony\Component\HttpFoundation\Request;
 use Symfony\Component\HttpFoundation\Cookie;
 
 class AjaxProxyController extends Controller {
 	/**
 	 * @Route(&quot;/r/ajax/proxy&quot;, name=&quot;_ajaxProxy&quot;)
 	 * @Template()
 	 */
 	public function proxyAction(Request $request)
 	{
 		// Forbid every request but jquery's XHR
 		if (!$request-&gt;isXmlHttpRequest()) {// isn't it an Ajax request?
 			return new Response('', 404, 
                             array('Content-Type' =&gt; 'application/json'));
 		}
 		
 		$restUrl = $request-&gt;request-&gt;get('restUrl');
 		$method = $request-&gt;request-&gt;get('method');
 		$params = $request-&gt;request-&gt;get('params');
 		$contentType = $request-&gt;request-&gt;get('contentType');
 		
 		if ($contentType == null) {
 			$contentType = 'application/json';
 		}
 	
 		if ($restUrl == null || $method == null || 
                         !in_array($method, array('GET', 'POST', 'DELETE'))) {
 			return new Response('', 404, array('Content-Type' =&gt; $contentType));
 		}
 	    
 		session_write_close();
 		$ch = curl_init();
 		curl_setopt($ch, CURLOPT_URL, $restUrl);
 		curl_setopt($ch, CURLOPT_HEADER, true);
 		curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
 		if ($params != null) {
 			curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
 		}
 		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
 		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
 		
 		$requestCookies = $request-&gt;cookies-&gt;all();
 		
 		$cookieArray = array();
 		foreach ($requestCookies as $cookieName =&gt; $cookieValue) {
 			$cookieArray[] = &quot;{$cookieName}={$cookieValue}&quot;;
 		}
 		$cookie_string = implode('; ', $cookieArray);
 		curl_setopt($ch, CURLOPT_COOKIE, $cookie_string);
 		
 		$response = curl_exec($ch);
 		curl_close($ch);
 		
 		list($headers, $response) = explode(&quot;\r\n\r\n&quot;,$response,2);
 		preg_match_all('/Set-Cookie: (.*)\b/', $headers, $cookies);
 		$cookies = $cookies[1];
 			
 		if ($response === false) {
 			return new Response('', 404, array('Content-Type' =&gt; $contentType));
 		} else {
 			$response = new Response($response, 200, 
                                              array('Content-Type' =&gt; $contentType));
 			foreach($cookies as $rawCookie) {
 				$cookie = \Symfony\Component\BrowserKit\Cookie::fromString($rawCookie);
 				$value = $cookie-&gt;getValue();
 				if (!empty($value)) {
 					$value = str_replace(' ', '+', $value);
 				}
 				$customCookie = new Cookie($cookie-&gt;getName(), $value, $cookie-&gt;getExpiresTime()==null?0:$cookie-&gt;getExpiresTime(), $cookie-&gt;getPath());
 				$response-&gt;headers-&gt;setCookie($customCookie);
 			}
 			return $response;
 		}
 	}
}
</code></pre>
<p><strong>Read more about this topic:</strong><br>
<a href="http://developer.yahoo.com/javascript/howto-proxy.html">http://developer.yahoo.com/javascript/howto-proxy.html</a></p>
<p><a href="https://twitter.com/#!/svlada">Follow me on Twitter</a></p>


<p><a href="/">← Home</a></p>

    </main>

    <footer></footer>

    <!-- Current page: /require-js-dependency-management-part1/ -->
  </body>
</html>
