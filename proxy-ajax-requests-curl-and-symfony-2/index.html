<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Proxying cross-domain requests using Symfony 2">
  <meta property="og:site_name" content="Freelance Software Developer">
  <title>Proxying cross-domain requests using Symfony 2</title>
  <meta name="description" content="Proxy Ajax requests, Curl and Symfony 2">
  <meta name="author" content="Vlada Stankovic">

  <link rel="stylesheet" href="/css/svlada.css?v=1.0.0">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Vladimir Stankovic - Software engineer">

  <script type="application/ld+json">
  {
      "@context": "http://schema.org/",
      "@type": "Person",
      "name": "Vladimir Stankovic",
      "alternateName": "Vlada, Svlada",
      "url": "https://www.svlada.com",
      "image": "",
      "sameAs": [
          "https://github.com/svlada",
          "https://twitter.com/svlada",
          "https://www.linkedin.com/in/svlada",
          "https://news.ycombinator.com/user?id=hawkweed"=
      ]
  }
  </script>
</head>

<body>
  <header>
    <a href="/" class="site-title">@svlada</a>
    <nav>
      <a href="/">posts</a>
      <a href="/about">about</a>
      <a href="/feed/feed.xml">rss</a>
    </nav>
  </header>

  <main>
    <article>
    <h1>Proxying cross-domain requests using Symfony 2</h1>
    <p class="post-date">Published: Dec 23, 2013 </p>
    
    <p>This article explains how to initiate cross-domain requests through a proxy using cURL and Symfony 2.</p>
<p>üëâ Jump to <a href="#source-code">#source-code</a>.</p>
<p>The usual scenario looks like this:</p>
<ol>
<li>The client sends an AJAX request to your server.</li>
<li>Your server forwards the request to an external (remote) server.</li>
<li>The server waits for the response from the remote server.</li>
<li>The response is parsed and processed.</li>
<li>The processed response is sent back to the client.</li>
</ol>
<p>As a first step, check if the client request is an XmlHttpRequest. Symfony 2 provides a built-in method for this:</p>
<pre class="language-php"><code class="language-php"> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">isXmlHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h3>Step 1: Client Code</h3>
<p>The following steps describe how to create an AJAX request.</p>
<ol>
<li>Specify the REST URL on the server for handling cross-domain AJAX requests: <code>url: &quot;{{ path('_ajaxProxy') }}&quot;</code></li>
<li>Wrap the request data.</li>
</ol>
<p>You'll need some data to create a cURL request on the server side.</p>
<p>For this example, send an object with the following properties to your server:</p>
<ul>
<li><strong>url</strong> ‚Üí the remote server endpoint to call</li>
<li><strong>method</strong> ‚Üí the HTTP method (e.g., GET, POST)</li>
<li><strong>params</strong> ‚Üí request parameters or payload data</li>
</ul>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">restUrl</span><span class="token operator">:</span> <span class="token string">"external-api-url"</span><span class="token punctuation">,</span> <span class="token comment">// Your target url on remote server</span>
<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token comment">// Type of request you want to issue to remote server</span>
<span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">"getFriendsList"</span> <span class="token comment">// Parameters you are sending to remote server</span>
<span class="token punctuation">}</span></code></pre>
<h3>Step 2: Forward the Request to the Remote Server</h3>
<p>This step is a bit more involved.</p>
<p>When the client request reaches your server, the first task is to parse and validate the request data.</p>
<p>To recap, your server needs the following information from the client:</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$restUrl</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'restUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Your target url on remote server</span>
<span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Type of request you want to issue to remote server</span>
<span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Parameters you are sending to remote server</span>
<span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'contentType'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Content-type</span></code></pre>
<h3>Step 3: Create the cURL Request</h3>
<p>On the server side, create a cURL request and set its parameters using the values received from the client.</p>
<pre class="language-php"><code class="language-php"><span class="token comment">// Initialize curl handle</span>
<span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// Set request url</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$restUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// TRUE to include the header in the output.</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// A custom request method to use instead of "GET" or "HEAD" when doing a HTTP request.  </span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CUSTOMREQUEST</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token operator">!=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The full data to post in a HTTP "POST" operation.</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>I strongly recommend reading the <a href="http://php.net/manual/en/function.curl-setopt.php">PHP manual on curl_setopt</a> to get familiar with the available cURL configuration options.</p>
<p>At this point, you have all the necessary data to send a request to the remote server. After executing the cURL handle, the response from the remote server will be stored in the <code>$response</code> variable.</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>You now have a basic setup. Next, let's add cookie support to the AJAX proxy.</p>
<p>Why do we need cookies?</p>
<p>In my case, I had to integrate a Symfony 2 application with a WordPress portal. Authentication was handled on the WordPress side, while the Symfony application relied on WordPress cookies to authorize users for accessing protected features.</p>
<p>In production, both applications shared the same domain. But in the test environment, things were more complicated‚Äîdifferent domains, ports, and other inconsistencies made the setup messy.</p>
<p>Where's the problem?</p>
<p>The Symfony 2 application needed to consume protected backend functionality from WordPress. Since much of the data was personalized and fetched via AJAX calls, cookies were required to maintain authentication and authorization.</p>
<h3>Getting Cookies from Symfony 2 and Passing Them to cURL</h3>
<p>To forward cookies from a Symfony 2 request to a remote server, you need to:</p>
<ol>
<li>Extract cookies from the Symfony request object.</li>
<li>Format them into a string that cURL understands.</li>
<li>Set them on the cURL handle.</li>
</ol>
<pre class="language-php"><code class="language-php"><span class="token comment">// Get all cookies from Symfony request object</span>
<span class="token variable">$requestCookies</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">cookies</span><span class="token operator">-></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// Prepare and set multiple cookies to curl handle</span>
<span class="token variable">$cookieArray</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestCookies</span> <span class="token keyword">as</span> <span class="token variable">$cookieName</span> <span class="token operator">=></span> <span class="token variable">$cookieValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$cookieArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieName</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieValue</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Be sure to set whitespace after '; ' when creating cookie string</span>
<span class="token variable">$cookie_string</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$cookieArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_COOKIE</span><span class="token punctuation">,</span> <span class="token variable">$cookie_string</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3>Getting Cookies from cURL Response and Passing Them to Symfony Response</h3>
<p>When you configure cURL with <code>CURLOPT_HEADER = true</code>, the response will include both headers and body. From there, you can parse the Set-Cookie headers and attach them to your Symfony response.</p>
<pre class="language-php"><code class="language-php"><span class="token comment">// Get header and response data from curl response</span>
<span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r\n\r\n"</span><span class="token punctuation">,</span><span class="token variable">$response</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// We are using regex to parse cookies from curl response</span>
<span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/Set-Cookie: (.*)\b/'</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$cookies</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Store cookies</span>
<span class="token variable">$cookies</span> <span class="token operator">=</span> <span class="token variable">$cookies</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>Raw cookies are parsed into an array, then each entry is converted to a Symfony Cookie and added to the response headers.</p>
<pre class="language-php"><code class="language-php"><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$cookies</span> <span class="token keyword">as</span> <span class="token variable">$rawCookie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>BrowserKit<span class="token punctuation">\</span>Cookie</span><span class="token operator">::</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token variable">$rawCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'+'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token variable">$customCookie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> 
        <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">null</span><span class="token operator">?</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span><span class="token operator">-></span><span class="token property">headers</span><span class="token operator">-></span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token variable">$customCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>‚ö†Ô∏è <strong>Final Notice:</strong><br>
Be sure to close and store session data before initializing the cURL handle‚Äîotherwise, you may run into a deadlock.</p>
<pre class="language-php"><code class="language-php"><span class="token function">session_write_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>What happens if you forget to close the session?</p>
<p>When PHP uses the default session handler, it locks the session file for the duration of the request. If S1 (a PHP script) starts a cURL POST to S2 (another PHP script) on the same server and both share the same session:</p>
<ul>
<li>S1 has the session locked.</li>
<li>S2 can't start (it tries to open the same session and blocks).</li>
<li>S1 is waiting for S2's response‚Ä¶ which never comes because S2 is blocked by the lock.</li>
<li>Result: deadlock.</li>
</ul>
<p>Fix: call <code>session_write_close();</code> before you open the cURL handle so other requests can read the session.</p>
<h3>Complete source code listing for the AJAX proxy (Symfony 2)</h3>
<p><strong>Client sample code</strong></p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sendAjaxRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"{{ path('_ajaxProxy') }}"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">restUrl</span> <span class="token operator">:</span> <span class="token string">"/external-api-url/"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token string">"getFriendList"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> textStatus<span class="token punctuation">,</span> jqXHR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Server proxy code</strong></p>
<pre class="language-php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">Proxy<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>ProxyBundle<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Template</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkBundle<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Method</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Cookie</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">AjaxProxyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
<span class="token comment">/**
    * @Route("/r/ajax/proxy", name="_ajaxProxy")
    * @Template()
    */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">proxyAction</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Forbid every request but jquery's XHR</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">isXmlHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// isn't it an Ajax request?</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> 
                            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token variable">$restUrl</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'restUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'contentType'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$contentType</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'application/json'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$restUrl</span> <span class="token operator">==</span> <span class="token keyword type-declaration">null</span> <span class="token operator">||</span> <span class="token variable">$method</span> <span class="token operator">==</span> <span class="token keyword type-declaration">null</span> <span class="token operator">||</span> 
                        <span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span> <span class="token operator">=></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">session_write_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$restUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CUSTOMREQUEST</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token operator">!=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token variable">$requestCookies</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token property">cookies</span><span class="token operator">-></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token variable">$cookieArray</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestCookies</span> <span class="token keyword">as</span> <span class="token variable">$cookieName</span> <span class="token operator">=></span> <span class="token variable">$cookieValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$cookieArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieName</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieValue</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$cookie_string</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$cookieArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_COOKIE</span><span class="token punctuation">,</span> <span class="token variable">$cookie_string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\r\n\r\n"</span><span class="token punctuation">,</span><span class="token variable">$response</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/Set-Cookie: (.*)\b/'</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$cookies</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$cookies</span> <span class="token operator">=</span> <span class="token variable">$cookies</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span> <span class="token operator">=></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> 
                                            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span> <span class="token operator">=></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$cookies</span> <span class="token keyword">as</span> <span class="token variable">$rawCookie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>BrowserKit<span class="token punctuation">\</span>Cookie</span><span class="token operator">::</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token variable">$rawCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'+'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$customCookie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">null</span><span class="token operator">?</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-></span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$response</span><span class="token operator">-></span><span class="token property">headers</span><span class="token operator">-></span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token variable">$customCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Read more about this topic:</strong></p>
<ul>
<li><a href="http://developer.yahoo.com/javascript/howto-proxy.html">http://developer.yahoo.com/javascript/howto-proxy.html</a></li>
</ul>

    
    <hr>
    <p><a href="/">‚Üê back to home</a></p>
</article>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://svlada.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  </main>

<!-- No JavaScript needed for this minimal theme -->

<script data-goatcounter="https://svlada.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>

