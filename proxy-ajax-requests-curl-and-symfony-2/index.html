<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Proxying cross-domain requests using Symfony 2">
  <meta property="og:site_name" content="Freelance Software Developer">
  <title>Proxying cross-domain requests using Symfony 2</title>
  <meta name="description" content="Proxy Ajax requests, Curl and Symfony 2">
  <meta name="author" content="Vlada Stankovic">

  <link rel="stylesheet" href="/css/prism-base16-ateliersulphurpool.light.css">
  <link rel="stylesheet" href="/css/index.css?v=1.2.0">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Vladimir Stankovic - Software engineer">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-28773758-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-28773758-1');
  </script>
  <script type="application/ld+json">
  {
      "@context": "http://schema.org/",
      "@type": "Person",
      "name": "Vladimir Stankovic",
      "alternateName": "Vlada, Svlada",
      "url": "https://www.svlada.com",
      "image": "",
      "sameAs": [
          "https://github.com/svlada",
          "https://twitter.com/svlada",
          "https://www.linkedin.com/in/svlada",
          "https://news.ycombinator.com/user?id=hawkweed"=
      ]
  }
  </script>
</head>

<body class="center">
  <header>
    <img src="/img/avatar.new.4x6.jpg" alt="" style="border-radius: 12px; width: 3rem; height: 3rem; float: left; margin-right: 20px">
    <div style="float: left">
      <ul class="nav">
        <li class="nav-item" style="padding-right: 20px"><strong>
          <a class="purple-text" href="/">Vladimir Stankovic</a>
        </strong></li>
        
        <!--
          <li class="nav-item" >
            <a class="purple-text " href="/">Blog</a>
          </li>
          
          <li class="nav-item">
            <a class="purple-text " href="/art/"></a>
          </li>
          
          <li class="nav-item">
            <a class="purple-text " href="/about/">About</a>
          </li>
          -->
      </ul>
  
      <p style="width: 100%; float: left; margin: 0; font-size:12px"><a class="purple-text" href="https://github.com/svlada" target="_blank">GitHub</a>, <a class="purple-text" href="https://www.linkedin.com/in/svlada" target="_blank">LinkedIn</a>,  <a class="purple-text" href="https://twitter.com/svlada" target="_blank">Twitter</a>, <a class="purple-text" href="mailto:svlada@gmail.com">Email</a></p>
    </div>
    
  </header>
  
  <main class="tmpl-post" >
    <h1>Proxying cross-domain requests using Symfony 2</h1>

<div class="dt-published" datetime="Mon Dec 23 2013 00:00:00 GMT+0000 (Coordinated Universal Time)">Monday, December 23, 2013</div>

<p>This article provides information on how to initiate cross-domain requests through the proxy using Curl and Symfony 2.</p>
<p>Jump to the <a href="#source-code">#source-code</a>.</p>
<p>The usual scenario looks like this:</p>
<ol>
<li>The client sends ajax request to the server</li>
<li>Your server forwards request to external/remote server</li>
<li>Waiting on response from a remote server</li>
<li>Parse and process response from remote server</li>
<li>Send response back to the client</li>
</ol>
<p>First, check if the client request is XmlHttpRequest. This can be done using Symfony 2 built-in method:</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isXmlHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<h3 id="step-1%3A-client-code">STEP 1: Client code <a class="direct-link" href="#step-1%3A-client-code" aria-hidden="true">#</a></h3>
<p>The following are the steps for creating an Ajax request.</p>
<ol>
<li>Specify rest URL on the server for handling cross-domain ajax requests.<code>url: &quot;&quot;</code></li>
<li>Wrap request data</li>
</ol>
<p>We need some data to create a curl request on the server-side.</p>
<p>For this example, you need to send an object with the following properties to your server.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">restUrl<span class="token punctuation">:</span> <span class="token string">"external-api-url"</span><span class="token punctuation">,</span> <span class="token comment">// Your target url on remote server</span></span><br><span class="highlight-line">method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token comment">// Type of request you want to issue to remote server</span></span><br><span class="highlight-line">params<span class="token punctuation">:</span> <span class="token punctuation">{</span> </span><br><span class="highlight-line">    action<span class="token punctuation">:</span> <span class="token string">"getFriendsList"</span> <span class="token comment">// Parameters you are sending to remote server</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<h3 id="step-2%3A-forward-request-to-remote-server">STEP 2: Forward request to remote server <a class="direct-link" href="#step-2%3A-forward-request-to-remote-server" aria-hidden="true">#</a></h3>
<p>This step is a bit tricky.</p>
<p>The client request arrives to your server-side code. First, you need to parse and validate request data.</p>
<p>To repeat once more ... you'll need the following data on server:</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token variable">$restUrl</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'restUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Your target url on remote server</span></span><br><span class="highlight-line"><span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Type of request you want to issue to remote server</span></span><br><span class="highlight-line"><span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Parameters you are sending to remote server</span></span><br><span class="highlight-line"><span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'contentType'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Content-type</span></span></code></pre>
<p>Create curl request and set parameters that you've got from the client.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token comment">// Initialize curl handle</span></span><br><span class="highlight-line"><span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><br><span class="highlight-line"><span class="token comment">// Set request url</span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$restUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><br><span class="highlight-line"><span class="token comment">// TRUE to include the header in the output.</span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><br><span class="highlight-line"><span class="token comment">// A custom request method to use instead of "GET" or "HEAD" when doing a HTTP request.  </span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CUSTOMREQUEST</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token operator">!=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// The full data to post in a HTTP "POST" operation.</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>I strongly suggest reading the PHP manual to get familiar with the curl configuration: <a href="http://php.net/manual/en/function.curl-setopt.php">http://php.net/manual/en/function.curl-setopt.php</a></p>
<p>You have enough data to send a request to the remote server. After executing the curl handle, the response from the remote server is stored in $response variable.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>You have a basic setup. Now we are going to add cookie support to our ajax proxy.</p>
<p>Why do we need cookies?</p>
<p>Recently I needed to integrate Symfony 2 application with WordPress portal. Authentication is done on the Wordpress side, and Symfony application is using WordPress cookies to authorize users for accessing protected features.</p>
<p>In production, both applications share the same domain, but in the test environment, there is a lot of mess (different domains, ports, etc).</p>
<p>Where is the problem?</p>
<p>An application written in Symfony 2 needs to consume some protected backend functionalities on the Wordpress side. There is a lot of personalized data that is fetched via ajax calls, and this is the reason why we need cookies.</p>
<h3 id="how-to-get-cookies-from-symfony2-request-and-set-multiple-cookies-to-curl%3F">How to get cookies from Symfony2 request and set multiple cookies to Curl? <a class="direct-link" href="#how-to-get-cookies-from-symfony2-request-and-set-multiple-cookies-to-curl%3F" aria-hidden="true">#</a></h3>
<p>We need to extract multiple cookies from Symfony 2 request objects and set them to curl handle.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token comment">// Get all cookies from Symfony request object</span></span><br><span class="highlight-line"><span class="token variable">$requestCookies</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">cookies</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><br><span class="highlight-line"><span class="token comment">// Prepare and set multiple cookies to curl handle</span></span><br><span class="highlight-line"><span class="token variable">$cookieArray</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestCookies</span> <span class="token keyword">as</span> <span class="token variable">$cookieName</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$cookieValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token variable">$cookieArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieName</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieValue</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token comment">// Be sure to set whitespace after '; ' when creating cookie string</span></span><br><span class="highlight-line"><span class="token variable">$cookie_string</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$cookieArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_COOKIE</span><span class="token punctuation">,</span> <span class="token variable">$cookie_string</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<h3 id="how-to-get-cookies-curl-response-and-set-multiple-cookies-to-symfony-response%3F">How to get cookies Curl response and set multiple cookies to Symfony response? <a class="direct-link" href="#how-to-get-cookies-curl-response-and-set-multiple-cookies-to-symfony-response%3F" aria-hidden="true">#</a></h3>
<p>Remember when we configured curl with CURLOPT_HEADER=true? Now we are going to parse cookies from curl Http response.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token comment">// Get header and response data from curl response</span></span><br><span class="highlight-line"><span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"\r\n\r\n"</span><span class="token punctuation">,</span><span class="token variable">$response</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token comment">// We are using regex to parse cookies from curl response</span></span><br><span class="highlight-line"><span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/Set-Cookie: (.*)\b/'</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$cookies</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token comment">// Store cookies</span></span><br><span class="highlight-line"><span class="token variable">$cookies</span> <span class="token operator">=</span> <span class="token variable">$cookies</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Raw cookies are parsed and stored in cookie array. Then each cookie needs to be converted to Symfony Cookie object and injected to Symfony response headers.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$cookies</span> <span class="token keyword">as</span> <span class="token variable">$rawCookie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token variable">$cookie</span> <span class="token operator">=</span> \<span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>BrowserKit<span class="token punctuation">\</span>Cookie</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token variable">$rawCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">' '</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'+'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token variable">$customCookie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> </span><br><span class="highlight-line">        <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">null</span><span class="token operator">?</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">headers</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token variable">$customCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span></code></pre>
<p><strong>FINAL NOTICE:</strong></p>
<p>Close and store session data before initializing curl handle or you can run into a deadlock.</p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token function">session_write_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>What could happen if you forgot to close the session?</p>
<p>Here is one scenario:</p>
<p>PHP script S1 creates/sends a curl POST request to script S2 on the same Apache server/PHP Environment. If pages S1 and S2 share the same session, script S2 will not start executing until the end of script S1 lifetime. But script S1 is waiting on a response from script S2. This is the point where deadlock happens. The default session handler locks the session file for the duration of the page request.</p>
<p><a id="source-code" name="source-code">Complete source code listing for ajax proxy</a></p>
<p><strong>Client sample code</strong></p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">sendAjaxRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        type<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        url<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        restUrl <span class="token punctuation">:</span> <span class="token string">"/external-api-url/"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            params<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            action<span class="token punctuation">:</span> <span class="token string">"getFriendList"</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> textStatus<span class="token punctuation">,</span> jqXHR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token operator">...</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p><strong>Server proxy code</strong></p>
<pre class="language-php"><code class="language-php"><span class="highlight-line"><span class="token keyword">namespace</span> <span class="token package">Proxy<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>ProxyBundle<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Template</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkBundle<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Method</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Sensio<span class="token punctuation">\</span>Bundle<span class="token punctuation">\</span>FrameworkExtraBundle<span class="token punctuation">\</span>Configuration<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>Cookie</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">AjaxProxyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span><br><span class="token comment">/**<br><span class="highlight-line">    * @Route("/r/ajax/proxy", name="_ajaxProxy")</span><br><span class="highlight-line">    * @Template()</span><br>    */</span><br><span class="highlight-line"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">proxyAction</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// Forbid every request but jquery's XHR</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isXmlHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// isn't it an Ajax request?</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> </span><br><span class="highlight-line">                            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Content-Type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token variable">$restUrl</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'restUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$params</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'contentType'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$contentType</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token variable">$contentType</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'application/json'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$restUrl</span> <span class="token operator">==</span> <span class="token constant">null</span> <span class="token operator">||</span> <span class="token variable">$method</span> <span class="token operator">==</span> <span class="token constant">null</span> <span class="token operator">||</span> </span><br><span class="highlight-line">                        <span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GET'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'POST'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'DELETE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Content-Type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token function">session_write_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$restUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_CUSTOMREQUEST</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token operator">!=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token variable">$requestCookies</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">cookies</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token variable">$cookieArray</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestCookies</span> <span class="token keyword">as</span> <span class="token variable">$cookieName</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$cookieValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token variable">$cookieArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieName</span><span class="token punctuation">}</span></span>=<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$cookieValue</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token variable">$cookie_string</span> <span class="token operator">=</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'; '</span><span class="token punctuation">,</span> <span class="token variable">$cookieArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_COOKIE</span><span class="token punctuation">,</span> <span class="token variable">$cookie_string</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"\r\n\r\n"</span><span class="token punctuation">,</span><span class="token variable">$response</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/Set-Cookie: (.*)\b/'</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">,</span> <span class="token variable">$cookies</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$cookies</span> <span class="token operator">=</span> <span class="token variable">$cookies</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        </span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Content-Type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> </span><br><span class="highlight-line">                                            <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Content-Type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$contentType</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$cookies</span> <span class="token keyword">as</span> <span class="token variable">$rawCookie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token variable">$cookie</span> <span class="token operator">=</span> \<span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>BrowserKit<span class="token punctuation">\</span>Cookie</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token variable">$rawCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">' '</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'+'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">            <span class="token variable">$customCookie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">null</span><span class="token operator">?</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getExpiresTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$cookie</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">headers</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token variable">$customCookie</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p><strong>Read more about this topic:</strong><br>
<a href="http://developer.yahoo.com/javascript/howto-proxy.html">http://developer.yahoo.com/javascript/howto-proxy.html</a></p>
<p><a href="https://twitter.com/#!/svlada">Follow me on Twitter</a></p>


<p><a href="/">← Home</a></p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://svlada.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
    <footer></footer>
    <!-- Current page: /proxy-ajax-requests-curl-and-symfony-2/ -->
</body>
</html>
