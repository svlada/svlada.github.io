<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public key authentication with Java over SSH</title>
  <meta name="Description" content="This article shows how to securely connect (i.e. establish ssh connection) to the remote host from java application.">
  
  <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans&display=swap" rel="stylesheet">

  <link href="/css/fonts.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/prism-base16-ateliersulphurpool.light.css">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Vladimir Stankovic - Software engineer">
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-28773758-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-28773758-1');
  </script>
</head>

<body class="center">
  <header>
    <ul class="nav"><li class="nav-item"><a
          href="/">Home</a></li><li class="nav-item"><a
          href="/posts/">Articles</a></li><li class="nav-item"><a
          href="/art/">Art</a></li><li class="nav-item"><a
          href="/hire-me/">Have a project in mind? Let&#39;s talk!</a></li></ul>
  </header>
  <main class="tmpl-post" >
    <h1>Public key authentication with Java over SSH</h1>

<h2 id="table-of-contents%3A">Table of contents: <a class="direct-link" href="#table-of-contents%3A">#</a></h2>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#generate-key-pair">Generate Key Pair</a></li>
<li><a href="#copy-public-key-to-remote-host">Copy public key to remote host</a></li>
<li><a href="#java-code">Connect to remote host from java</a></li>
<li><a href="#source-code">Source code</a></li>
</ol>
<h3 id="introduction"><a name="introduction" id="introduction">Introduction</a> <a class="direct-link" href="#introduction">#</a></h3>
<p>This article shows how to securely connect (i.e. establish ssh connection) to the remote host from java application. In addition, configuration details for enabling public key authentication and protecting ssh keys will be provided.</p>
<p>Public key authentication enable users to establish SSH connection without providing (i.e. typing in) explicit password. Immediate benefit is that password is not transfered over the network, thus preventing posibility of password being compromised.</p>
<p>Private key should be stored in the ssh keychain and protected with the encryption passphrase.</p>
<h3 id="generate-key-pair"><a name="generate-key-pair" id="generate-key-pair">Generate Key Pair</a> <a class="direct-link" href="#generate-key-pair">#</a></h3>
<p>The first step is to generate private / public key on server where your java application will be running.</p>
<p>Private / public key pair can be generated by executing the following command:</p>
<pre class="language-text"><code class="language-text"><span class="highlight-line">ssh-keygen -t rsa</span></code></pre>
<p>Here is the output from my local development box:</p>
<pre class="language-text"><code class="language-text"><span class="highlight-line">vladimir.stankovic@PCSVLADA ~</span><br><span class="highlight-line">$ ssh-keygen -t rsa</span><br><span class="highlight-line">Generating public/private rsa key pair.</span><br><span class="highlight-line">Enter file in which to save the key (/home/vladimir.stankovic/.ssh/id_rsa):</span><br><span class="highlight-line">Enter passphrase (empty for no passphrase):</span><br><span class="highlight-line">Enter same passphrase again:</span><br><span class="highlight-line">Your identification has been saved in /home/vladimir.stankovic/.ssh/id_rsa.</span><br><span class="highlight-line">Your public key has been saved in /home/vladimir.stankovic/.ssh/id_rsa.pub.</span></code></pre>
<p>Private key is identified as <code>id_rsa</code> and public key as a <code>id_rsa.pub</code>.</p>
<h3 id="copy-public-key-to-remote-host"><a name="copy-public-key-to-remote-host" id="">Copy public key to remote host</a> <a class="direct-link" href="#copy-public-key-to-remote-host">#</a></h3>
<p>The <code>ssh-copy-id</code> copies the public key of your default identity (use -i identity_file for other identities) to the remote host.</p>
<pre class="language-text"><code class="language-text"><span class="highlight-line">vladimir.stankovic@PCSVLADA ~</span><br><span class="highlight-line">$ ssh-copy-id -i /home/vladimir.stankovic/.ssh/id_rsa root@www.svlada.com</span><br><span class="highlight-line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="highlight-line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="highlight-line">root@www.svlada.com's password:</span><br><span class="highlight-line">Number of key(s) added: 1</span><br><span class="highlight-line">Now try logging into the machine, with:   "ssh 'root@www.svlada.com'"</span><br><span class="highlight-line">and check to make sure that only the key(s) you wanted were added.</span></code></pre>
<h3 id="connect-to-remote-host-from-java"><a name="java-code" id="java-code">Connect to remote host from java</a> <a class="direct-link" href="#connect-to-remote-host-from-java">#</a></h3>
<p>I have used <a href="http://www.jcraft.com/jsch/">JSch library</a> to establish SSH connection.</p>
<p>The most important part is configuration of <code>com.jcraft.jsch.Session</code> object and adding <code>publickey</code> to the list of <code>PreferredAuthentication</code> options.</p>
<p>Here is the sample code for configuring public key authentication:</p>
<pre class="language-java"><code class="language-java"><span class="highlight-line">    <span class="token class-name">JSch</span> jsch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token class-name">Session</span> session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token class-name">String</span> privateKeyPath <span class="token operator">=</span> <span class="token string">"/home/vladimir.stankovic/.ssh/id_rsa"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        jsch<span class="token punctuation">.</span><span class="token function">addIdentity</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>	    </span><br><span class="highlight-line">        session <span class="token operator">=</span> jsch<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        session<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token string">"PreferredAuthentications"</span><span class="token punctuation">,</span> <span class="token string">"publickey,keyboard-interactive,password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Properties</span> config <span class="token operator">=</span> <span class="token keyword">new</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><br><span class="highlight-line">        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"StrictHostKeyChecking"</span><span class="token punctuation">,</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        session<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSchException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to create Jsch Session object."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span></code></pre>
<p>The next step is to connect to remote host and execute arbitary command over SSH:</p>
<pre class="language-java"><code class="language-java"><span class="highlight-line">    <span class="token class-name">String</span> command <span class="token operator">=</span> <span class="token string">"echo \"Sit down, relax, mix yourself a drink and enjoy the show...\" >> /tmp/test.out"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        session<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">openChannel</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelExec</span><span class="token punctuation">)</span> channel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelExec</span><span class="token punctuation">)</span> channel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPty</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        channel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        channel<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        session<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSchException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Error durring SSH command execution. Command: "</span> <span class="token operator">+</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span></code></pre>
<h3 id="source-code"><a name="source-code" id="source-code">Source code</a> <a class="direct-link" href="#source-code">#</a></h3>
<p>For full example you can checkout code from the following <a href="https://github.com/svlada/ssh-public-key-authentication">git repository</a>.</p>


<p><a href="/">← Home</a></p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://svlada.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
    <footer></footer>
    <!-- Current page: /ssh-public-key-authentication/ -->
</body>
</html>
