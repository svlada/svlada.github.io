<!DOCTYPE html><html lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:type" content="website">
  <meta property="og:title" content="JWT Authentication Tutorial">
  <meta property="og:site_name" content="Freelance Software Developer">
  <title>JWT Authentication Tutorial</title>
  <meta name="description" content="This article will guide you on how you can implement JWT authentication with Spring Boot.">
  <meta name="author" content="Vlada Stankovic">

  <link rel="stylesheet" href="/css/prism-base16-ateliersulphurpool.light.css?v=1.0.2">

  <!-- <link rel="stylesheet" href="/css/index.css?v=1.8.8"> -->
  
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css">  
  <style>
    h1, h2, h3, h4, h5 { color: #aaf; }

    .direct-link { display: none; }
    a { color: #aaf; }
    /* main a:visited { color: #e8f; } */
    main article > h2 a:visited { color: #5e5e8c;}
  </style>
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Vladimir Stankovic - Software engineer">

  <script type="application/ld+json">
  {
      "@context": "http://schema.org/",
      "@type": "Person",
      "name": "Vladimir Stankovic",
      "alternateName": "Vlada, Svlada",
      "url": "https://www.svlada.com",
      "image": "",
      "sameAs": [
          "https://github.com/svlada",
          "https://twitter.com/svlada",
          "https://www.linkedin.com/in/svlada",
          "https://news.ycombinator.com/user?id=hawkweed"=
      ]
  }
  </script>
</head>

<body class="w-100 sans-serif center mw7 bg-washed-gray ">
  <header>
    <nav class="pt4 pl4 pr4 pb0 ">
      <a class="link b f5 f5-ns dib mr3" href="/" title="Vladimir Stankovic">~</a>
      <a class="link f5 f5-ns dib mr3" href="/about" title="About">About</a>
    </nav>
  </header>
  <main class="">
    <section class="pa3 pa4-ns">
<article class="lh-copy">
    <h1 class="f3 lh-copy">JWT Authentication Tutorial</h1>
    <ol>
<li><a title="Introduction: JWT Token" href="#introduction">Introduction</a></li>
<li><a title="pre-requisites" href="#pre-requisites">Prerequisite</a></li>
<li><a title="Spring Security: Ajax authentication" href="#ajax-authentication">Ajax authentication</a></li>
<li><a title="jwt-authentication" href="#jwt-authentication">JWT Authentication</a></li>
</ol>
<h2 class="f4 lh-copy"><a name="introduction" id="introduction">Introduction</a></h2>
<p>This article is a guide on implementing JWT authentication with Spring Boot.</p>
<p>At a bare minimum, the client is required to exchange a username and password in order to obtain a JWT, which will be used for subsequent authenticated API calls.</p>
<p>Below are the core workflows for implementing API security:</p>
<ol>
<li>Ajax Login Authentication</li>
<li>JWT Token Authentication</li>
</ol>
<h2 class="f4 lh-copy"><a name="pre-requisites" id="pre-requisites">Prerequisite</a></h2>
<p>See the linked GitHub <a href="https://github.com/svlada/springboot-security-jwt">repo</a> for code.</p>
<p>This project is using H2 in-memory database to store sample user data. To make things easier I have created data fixtures and configured Spring Boot to automatically load them on the application startup (<code>/jwt-demo/src/main/resources/data.sql</code>).</p>
<p>The overall project structure is shown below:</p>
<pre class="language-java"><code class="language-java"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>main
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>java
<span class="token operator">|</span>   <span class="token operator">|</span>   \<span class="token operator">--</span><span class="token operator">-</span>com
<span class="token operator">|</span>   <span class="token operator">|</span>       \<span class="token operator">--</span><span class="token operator">-</span>svlada
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>common
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>entity
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>profile
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   \<span class="token operator">--</span><span class="token operator">-</span>endpoint
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>security
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>auth
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>ajax
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">|</span>   \<span class="token operator">--</span><span class="token operator">-</span>jwt
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">|</span>       <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>extractor
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">|</span>       \<span class="token operator">--</span><span class="token operator">-</span>verifier
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>config
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>endpoint
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>exceptions
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   \<span class="token operator">--</span><span class="token operator">-</span>model
<span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>       \<span class="token operator">--</span><span class="token operator">-</span>token
<span class="token operator">|</span>   <span class="token operator">|</span>           \<span class="token operator">--</span><span class="token operator">-</span>user
<span class="token operator">|</span>   <span class="token operator">|</span>               <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span>repository
<span class="token operator">|</span>   <span class="token operator">|</span>               \<span class="token operator">--</span><span class="token operator">-</span>service
<span class="token operator">|</span>   \<span class="token operator">--</span><span class="token operator">-</span>resources
<span class="token operator">|</span>       <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token keyword">static</span>
<span class="token operator">|</span>       \<span class="token operator">--</span><span class="token operator">-</span>templates</code></pre>
<h2 class="f4 lh-copy"><a name="ajax-authentication" id="ajax-authentication">Ajax authentication</a></h2>
<p>In the context of Ajax authentication, we typically mean a scenario where the user provides credentials via a JSON payload, which is transmitted as part of an XMLHttpRequest.</p>
<p>In the first part of this tutorial, Ajax authentication is implemented following standard patterns outlined in the Spring Security framework. The subsequent list outlines the components to be implemented:</p>
<ol>
<li>AjaxLoginProcessingFilter</li>
<li>AjaxAuthenticationProvider</li>
<li>AjaxAwareAuthenticationSuccessHandler</li>
<li>AjaxAwareAuthenticationFailureHandler</li>
<li>RestAuthenticationEntryPoint</li>
<li>WebSecurityConfig</li>
</ol>
<p>Before going into the implementation details, let's look at the request/response authentication flow.</p>
<p><strong>Ajax authentication request example</strong></p>
<p>The Authentication API allows users to exchange credentials for an authentication token.</p>
<p>In this example, the client initiates the authentication process by invoking Authentication API endpoint (<code>/api/auth/login</code>).</p>
<p>Raw HTTP request:</p>
<pre class="language-java"><code class="language-java"><span class="token constant">POST</span> <span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span>login <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Host</span><span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">9966</span>
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Requested</span><span class="token operator">-</span><span class="token class-name">With</span><span class="token operator">:</span> <span class="token class-name">XMLHttpRequest</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>cache

<span class="token punctuation">{</span>
    <span class="token string">"username"</span><span class="token operator">:</span> <span class="token string">"svlada@gmail.com"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token operator">:</span> <span class="token string">"test1234"</span>
<span class="token punctuation">}</span></code></pre>
<p>CURL:</p>
<pre class="language-java"><code class="language-java">curl <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">"X-Requested-With: XMLHttpRequest"</span> <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">"Cache-Control: no-cache"</span> <span class="token operator">-</span>d '<span class="token punctuation">{</span>
    <span class="token string">"username"</span><span class="token operator">:</span> <span class="token string">"svlada@gmail.com"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token operator">:</span> <span class="token string">"test1234"</span>
<span class="token punctuation">}</span>' <span class="token string">"http://localhost:9966/api/auth/login"</span></code></pre>
<p><strong>Ajax authentication response example</strong></p>
<p>If client supplied credentials are valid, Authentication API will respond with the HTTP response including the following details:</p>
<ol>
<li>HTTP status <em>200 OK</em></li>
<li>Signed JWT Access and Refresh tokens included in the response body</li>
</ol>
<p><strong>JWT Access token</strong> - used to authenticate against protected API resources. It must be set in <code>X-Authorization</code> header.</p>
<p><strong>JWT Refresh token</strong> - used to acquire new Access Token. Token refresh is handled by the following API endpoint: <code>/api/auth/token</code>.</p>
<p>Raw HTTP Response:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzdmxhZGFAZ21haWwuY29tIiwic2NvcGVzIjpbIlJPTEVfQURNSU4iLCJST0xFX1BSRU1JVU1fTUVNQkVSIl0sImlzcyI6Imh0dHA6Ly9zdmxhZGEuY29tIiwiaWF0IjoxNDcyMDMzMzA4LCJleHAiOjE0NzIwMzQyMDh9.41rxtplFRw55ffqcw1Fhy2pnxggssdWUU8CDOherC0Kw4sgt3-rw_mPSWSgQgsR0NLndFcMPh7LSQt5mkYqROQ"</span><span class="token punctuation">,</span>
  
  <span class="token property">"refreshToken"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzdmxhZGFAZ21haWwuY29tIiwic2NvcGVzIjpbIlJPTEVfUkVGUkVTSF9UT0tFTiJdLCJpc3MiOiJodHRwOi8vc3ZsYWRhLmNvbSIsImp0aSI6IjkwYWZlNzhjLTFkMmUtNDg2OS1hNzdlLTFkNzU0YjYwZTBjZSIsImlhdCI6MTQ3MjAzMzMwOCwiZXhwIjoxNDcyMDM2OTA4fQ.SEEG60YRznBB2O7Gn_5X6YbRmyB3ml4hnpSOxqkwQUFtqA6MZo7_n2Am2QhTJBJA1Ygv74F2IxiLv0urxGLQjg"</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>JWT Access Token</strong></p>
<p>JWT Access token is used for both, authentication and authorization:</p>
<ol>
<li>Authentication is performed by verifying the JWT Access Token signature. If the signature proves to be valid, access to the requested API resource is granted.</li>
<li>Authorization is done by looking up privileges in the <strong>scope</strong> attribute of JWT Access token.</li>
</ol>
<p>Decoded JWT Access token has three parts: Header, Claims and Signature as shown below:</p>
<p>Header</p>
<pre class="language-json"><code class="language-json">
<span class="token punctuation">{</span>
    <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS512"</span>
<span class="token punctuation">}</span></code></pre>
<p>Claims</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"svlada@gmail.com"</span><span class="token punctuation">,</span>
  <span class="token property">"scopes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"ROLE_ADMIN"</span><span class="token punctuation">,</span>
    <span class="token string">"ROLE_PREMIUM_MEMBER"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"http://svlada.com"</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1472033308</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1472034208</span>
<span class="token punctuation">}</span></code></pre>
<p>Signature (base64 encoded)</p>
<pre class="language-java"><code class="language-java"><span class="token number">41</span>rxtplFRw55ffqcw1Fhy2pnxggssdWUU8CDOherC0Kw4sgt3<span class="token operator">-</span>rw_mPSWSgQgsR0NLndFcMPh7LSQt5mkYqROQ</code></pre>
<p><strong>JWT Refresh Token</strong></p>
<p>Refresh token is long-lived token used to request new Access tokens. It's expiration time is greater than expiration time of Access token.</p>
<p>In this tutorial we'll use <code>jti</code> claim to maintain list of blacklisted or revoked tokens. JWT ID(<code>jti</code>) claim is defined by <a href="https://tools.ietf.org/html/rfc7519#section-4.1.7">RFC7519</a> with purpose to uniquely identify individual Refresh token.</p>
<p>Decoded Refresh token has three parts: Header, Claims and Signature as shown below:</p>
<p>Header</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS512"</span>
<span class="token punctuation">}</span></code></pre>
<p>Claims</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"svlada@gmail.com"</span><span class="token punctuation">,</span>
  <span class="token property">"scopes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"ROLE_REFRESH_TOKEN"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"http://svlada.com"</span><span class="token punctuation">,</span>
  <span class="token property">"jti"</span><span class="token operator">:</span> <span class="token string">"90afe78c-1d2e-4869-a77e-1d754b60e0ce"</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1472033308</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1472036908</span>
<span class="token punctuation">}</span></code></pre>
<p>Signature (base64 encoded)</p>
<pre><code>SEEG60YRznBB2O7Gn_5X6YbRmyB3ml4hnpSOxqkwQUFtqA6MZo7_n2Am2QhTJBJA1Ygv74F2IxiLv0urxGLQjg
</code></pre>
<h4>AjaxLoginProcessingFilter</h4>
<p>First step is to extend <code>AbstractAuthenticationProcessingFilter</code> in order to provide custom processing of Ajax authentication requests.</p>
<p>De-serialization and basic validation of the incoming JSON payload is done in the <code>AjaxLoginProcessingFilter#attemptAuthentication</code> method. Upon successful validation of the JSON payload authentication logic is delegated to AjaxAuthenticationProvider class.</p>
<p>In case of a successful authentication <code>AjaxLoginProcessingFilter#successfulAuthentication</code> method is invoked.<br>
In case of failure authentication  <code>AjaxLoginProcessingFilter#unsuccessfulAuthentication</code> method is invoked.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AjaxLoginProcessingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AjaxLoginProcessingFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">AjaxLoginProcessingFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultProcessUrl<span class="token punctuation">,</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">,</span> 
            <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>defaultProcessUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler <span class="token operator">=</span> successHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler <span class="token operator">=</span> failureHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objectMapper <span class="token operator">=</span> mapper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">WebUtil</span><span class="token punctuation">.</span><span class="token function">isAjax</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication method not supported. Request method: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthMethodNotSupportedException</span><span class="token punctuation">(</span><span class="token string">"Authentication method not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">LoginRequest</span> loginRequest <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LoginRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginRequest<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginRequest<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">"Username or Password not provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">UsernamePasswordAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>loginRequest<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginRequest<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
            <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>AjaxAuthenticationProvider</h4>
<p>Responsibility of the AjaxAuthenticationProvider class is to:</p>
<ol>
<li>Verify user credentials against database, LDAP or some other system which holds the user data</li>
<li>If <code>username</code> and <code>password</code> do not match the record in the database authentication exception is thrown</li>
<li>Create UserContext and populate it with user data you need (in our case just <code>username</code> and <code>user privileges</code>)</li>
<li>Upon successful authentication delegate creation of JWT Token to <code>AjaxAwareAuthenticationSuccessHandler</code></li>
</ol>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AjaxAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BCryptPasswordEncoder</span> encoder<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabaseUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxAuthenticationProvider</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DatabaseUserService</span> userService<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BCryptPasswordEncoder</span> encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>encoder <span class="token operator">=</span> encoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> <span class="token string">"No authentication data provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"User not found: "</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token string">"Authentication Failed. Username or Password not valid."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span><span class="token string">"User has no roles assigned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>authority <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>authority<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">UserContext</span> userContext <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userContext<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> userContext<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>AjaxAwareAuthenticationSuccessHandler</h4>
<p>We'll implement AuthenticationSuccessHandler interface that is called when client has been successfully authenticated.</p>
<p>AjaxAwareAuthenticationSuccessHandler class is our custom implementation of AuthenticationSuccessHandler interface. Responsibility of this class is to add JSON payload containing JWT Access and Refresh tokens into the HTTP response body.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AjaxAwareAuthenticationSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationSuccessHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtTokenFactory</span> tokenFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxAwareAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">JwtTokenFactory</span> tokenFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mapper <span class="token operator">=</span> mapper<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tokenFactory <span class="token operator">=</span> tokenFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserContext</span> userContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserContext</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">JwtToken</span> accessToken <span class="token operator">=</span> tokenFactory<span class="token punctuation">.</span><span class="token function">createAccessJwtToken</span><span class="token punctuation">(</span>userContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtToken</span> refreshToken <span class="token operator">=</span> tokenFactory<span class="token punctuation">.</span><span class="token function">createRefreshToken</span><span class="token punctuation">(</span>userContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tokenMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"refreshToken"</span><span class="token punctuation">,</span> refreshToken<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tokenMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">clearAuthenticationAttributes</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Removes temporary authentication-related data which may have been stored
     * in the session during the authentication process..
     * 
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clearAuthenticationAttributes</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        session<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebAttributes</span><span class="token punctuation">.</span><span class="token constant">AUTHENTICATION_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Let's focus for a moment on how JWT Access token is created. In this tutorial we are using <a href="https://github.com/jwtk/jjwt">Java JWT</a> library created by <a href="https://stormpath.com/">Stormpath</a>.</p>
<p>Make sure that <code>JJWT</code> dependency is included in your <code>pom.xml</code>.</p>
<pre class="language-java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>jsonwebtoken<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jjwt<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>jjwt<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span></code></pre>
<p>We have created factory class (<code>JwtTokenFactory</code>) to decouple token creation logic.</p>
<p>Method <code>JwtTokenFactory#createAccessJwtToken</code>  creates signed JWT Access token.</p>
<p>Method <code>JwtTokenFactory#createRefreshToken</code> creates signed JWT Refresh token.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtSettings</span> settings<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtTokenFactory</span><span class="token punctuation">(</span><span class="token class-name">JwtSettings</span> settings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>settings <span class="token operator">=</span> settings<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Factory method for issuing new JWT Tokens.
     * 
     * @param username
     * @param roles
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">AccessJwtToken</span> <span class="token function">createAccessJwtToken</span><span class="token punctuation">(</span><span class="token class-name">UserContext</span> userContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>userContext<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot create JWT Token without username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>userContext<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> userContext<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"User doesn't have any privileges"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">claims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>userContext<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"scopes"</span><span class="token punctuation">,</span> userContext<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DateTime</span> currentTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getTokenIssuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getTokenExpirationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span><span class="token function">getTokenSigningKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AccessJwtToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JwtToken</span> <span class="token function">createRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">UserContext</span> userContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>userContext<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot create JWT Token without username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">DateTime</span> currentTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">claims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>userContext<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"scopes"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">Scopes</span><span class="token punctuation">.</span><span class="token constant">REFRESH_TOKEN</span><span class="token punctuation">.</span><span class="token function">authority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getTokenIssuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getRefreshTokenExpTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span><span class="token function">getTokenSigningKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AccessJwtToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Please note that if you are instantiating Claims object outside of <code>Jwts.builder()</code> make sure to first invoke <code>Jwts.builder()#setClaims(claims)</code>. Why? Well, if you don't do that, Jwts.builder will, by default, create empty Claims object. What that means? Well if you call <code>Jwts.builder()#setClaims()</code> after you have set subject with <code>Jwts.builder()#setSubject()</code> your subject will be lost. Simply new instance of Claims class will overwrite default one created by Jwts.builder().</p>
<h4>AjaxAwareAuthenticationFailureHandler</h4>
<p>AjaxAwareAuthenticationFailureHandler is invoked by <code>AjaxLoginProcessingFilter</code> in case of authentication failures. You can design specific error messages based on exception type that have occurred during the authentication process.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AjaxAwareAuthenticationFailureHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxAwareAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mapper <span class="token operator">=</span> mapper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Invalid username or password"</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">AUTHENTICATION</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">JwtExpiredTokenException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Token has expired"</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">JWT_TOKEN_EXPIRED</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">AuthMethodNotSupportedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">AUTHENTICATION</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Authentication failed"</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span><span class="token constant">AUTHENTICATION</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 class="f4 lh-copy"><a name="jwt-authentication" id="jwt-authentication">JWT Authentication</a></h2>
<p>Token based authentication schema's became immensely popular in recent times, as they provide important benefits when compared to sessions/cookies:</p>
<ol>
<li>CORS</li>
<li>No need for CSRF protection</li>
<li>Better integration with mobile</li>
<li>Reduced load on authorization server</li>
<li>No need for distributed session store</li>
</ol>
<p>Some trade-offs have to be made with this approach:</p>
<ol>
<li>More vulnerable to XSS attacks</li>
<li>Access token can contain outdated authorization claims (e.g when some of the user privileges are revoked)</li>
<li>Access tokens can grow in size in case of increased number of claims</li>
<li>File download API can be tricky to implement</li>
<li>True statelessness and revocation are mutually exclusive</li>
</ol>
<p>In this article we'll investigate how JWT's can used for token based authentication.</p>
<p>JWT Authentication flow is very simple:</p>
<ol>
<li>User obtains Refresh and Access tokens by providing credentials to the Authorization server</li>
<li>User sends Access token with each request to access protected API resource</li>
<li>Access token is signed and contains user identity (e.g. user id) and authorization claims.</li>
</ol>
<p>It's important to note that authorization claims will be included with the Access token. Why is this important? Well, let's say that authorization claims (e.g user privileges in the database) are changed during the life time of Access token. Those changes will not become effective until new Access token is issued. In most cases this is not big issue, because Access tokens are short-lived. Otherwise go with the opaque token pattern.</p>
<p>Before we get to the details of the implementation, let's look the sample request to protected API resource.</p>
<p><strong>Signed request to protected API resource</strong></p>
<p>The following pattern is used for access tokens: <code>&lt;header-name&gt; Bearer &lt;access_token&gt;</code>.</p>
<p>In our example for header name (<code>&lt;header-name&gt;</code>) we are using <code>X-Authorization</code>.</p>
<p>Raw HTTP request:</p>
<pre class="language-java"><code class="language-java"><span class="token constant">GET</span> <span class="token operator">/</span>api<span class="token operator">/</span>me <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Host</span><span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">9966</span>
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Authorization</span><span class="token operator">:</span> <span class="token class-name">Bearer</span> <span class="token class-name"><span class="token namespace">eyJhbGciOiJIUzUxMiJ9<span class="token punctuation">.</span>eyJzdWIiOiJzdmxhZGFAZ21haWwuY29tIiwic2NvcGVzIjpbIlJPTEVfQURNSU4iLCJST0xFX1BSRU1JVU1fTUVNQkVSIl0sImlzcyI6Imh0dHA6Ly9zdmxhZGEuY29tIiwiaWF0IjoxNDcyMzkwMDY1LCJleHAiOjE0NzIzOTA5NjV9<span class="token punctuation">.</span></span>Y9BR7q3f1npsSEYubz</span><span class="token operator">-</span>u8tQ8dDOdBcVPFN7AIfWwO37KyhRugVzEbWVPO1obQlHNJWA0Nx1KrEqHqMEjuNWo5w
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>cache</code></pre>
<p>CURL:</p>
<pre class="language-java"><code class="language-java">curl <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">GET</span> <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">"X-Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJzdmxhZGFAZ21haWwuY29tIiwic2NvcGVzIjpbIlJPTEVfQURNSU4iLCJST0xFX1BSRU1JVU1fTUVNQkVSIl0sImlzcyI6Imh0dHA6Ly9zdmxhZGEuY29tIiwiaWF0IjoxNDcyMzkwMDY1LCJleHAiOjE0NzIzOTA5NjV9.Y9BR7q3f1npsSEYubz-u8tQ8dDOdBcVPFN7AIfWwO37KyhRugVzEbWVPO1obQlHNJWA0Nx1KrEqHqMEjuNWo5w"</span> <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">"Cache-Control: no-cache"</span> <span class="token string">"http://localhost:9966/api/me"</span></code></pre>
<p>Let's see the implementation details. Following are components we need to implement JWT Authentication:</p>
<ol>
<li>JwtTokenAuthenticationProcessingFilter</li>
<li>JwtAuthenticationProvider</li>
<li>SkipPathRequestMatcher</li>
<li>JwtHeaderTokenExtractor</li>
<li>BloomFilterTokenVerifier</li>
<li>WebSecurityConfig</li>
</ol>
<h4>JwtTokenAuthenticationProcessingFilter</h4>
<p>JwtTokenAuthenticationProcessingFilter filter is applied to each API (<code>/api/**</code>) with exception of the refresh token endpoint (<code>/api/auth/token</code>) and login endpoint (<code>/api/auth/login</code>).</p>
<p>This filter has the following responsibilities:</p>
<ol>
<li>Check for access token in <code>X-Authorization</code> header. If Access token is found in the header, delegate authentication to <code>JwtAuthenticationProvider</code> otherwise throw authentication exception</li>
<li>Invokes success or failure strategies based on the outcome of authentication process performed by <code>JwtAuthenticationProvider</code></li>
</ol>
<p>Please ensure that <code>chain.doFilter(request, response)</code> is invoked upon successful authentication. You want processing of the request to advance to the next filter, because very last one filter <code>FilterSecurityInterceptor#doFilter</code> is responsible to actually invoke method in your controller that is handling requested API resource.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTokenAuthenticationProcessingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TokenExtractor</span> tokenExtractor<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtTokenAuthenticationProcessingFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">,</span> 
            <span class="token class-name">TokenExtractor</span> tokenExtractor<span class="token punctuation">,</span> <span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler <span class="token operator">=</span> failureHandler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tokenExtractor <span class="token operator">=</span> tokenExtractor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> tokenPayload <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">WebSecurityConfig</span><span class="token punctuation">.</span><span class="token constant">JWT_TOKEN_HEADER_PARAM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RawAccessJwtToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawAccessJwtToken</span><span class="token punctuation">(</span>tokenExtractor<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span>tokenPayload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
            <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>JwtHeaderTokenExtractor</h4>
<p>JwtHeaderTokenExtractor is very simple class used to extract Authorization token from header. You can extend TokenExtractor interface and provide your custom implementation that will for example extract token from URL.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHeaderTokenExtractor</span> <span class="token keyword">implements</span> <span class="token class-name">TokenExtractor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">HEADER_PREFIX</span> <span class="token operator">=</span> <span class="token string">"Bearer "</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token class-name">String</span> header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">"Authorization header cannot be blank!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">HEADER_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">"Invalid authorization header size."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> header<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token constant">HEADER_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>JwtAuthenticationProvider</h4>
<p>JwtAuthenticationProvider has the following responsibilities:</p>
<ol>
<li>Verify the access token's signature</li>
<li>Extract identity and authorization claims from Access token and use them to create UserContext</li>
<li>If Access token is malformed, expired or simply if token is not signed with the appropriate signing key Authentication exception will be thrown</li>
</ol>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtSettings</span> jwtSettings<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticationProvider</span><span class="token punctuation">(</span><span class="token class-name">JwtSettings</span> jwtSettings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtSettings <span class="token operator">=</span> jwtSettings<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
        <span class="token class-name">RawAccessJwtToken</span> rawAccessToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RawAccessJwtToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> jwsClaims <span class="token operator">=</span> rawAccessToken<span class="token punctuation">.</span><span class="token function">parseClaims</span><span class="token punctuation">(</span>jwtSettings<span class="token punctuation">.</span><span class="token function">getTokenSigningKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> subject <span class="token operator">=</span> jwsClaims<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> scopes <span class="token operator">=</span> jwsClaims<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"scopes"</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> scopes<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>authority <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">UserContext</span> context <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationToken</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">JwtAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>SkipPathRequestMatcher</h4>
<p>JwtTokenAuthenticationProcessingFilter  filter is configured to skip following endpoints: <code>/api/auth/login</code> and <code>/api/auth/token</code>. This is achieved with <code>SkipPathRequestMatcher</code> implementation of <code>RequestMatcher</code>.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkipPathRequestMatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestMatcher</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">OrRequestMatcher</span> matchers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> processingMatcher<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">SkipPathRequestMatcher</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pathsToSkip<span class="token punctuation">,</span> <span class="token class-name">String</span> processingPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>pathsToSkip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> m <span class="token operator">=</span> pathsToSkip<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>path <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrRequestMatcher</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        processingMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span>processingPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>matchers<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> processingMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>WebSecurityConfig</h4>
<p>WebSecurityConfig class extends WebSecurityConfigurerAdapter to provide custom security configuration.</p>
<p>Following beans are configured and instantiated in this class:</p>
<ol>
<li>AjaxLoginProcessingFilter</li>
<li>JwtTokenAuthenticationProcessingFilter</li>
<li>AuthenticationManager</li>
<li>BCryptPasswordEncoder</li>
</ol>
<p>Also, inside <code>WebSecurityConfig#configure(HttpSecurity http)</code> method we'll configure patterns to define protected/unprotected API endpoints. Please note that we have disabled CSRF protection because we are not using Cookies.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">JWT_TOKEN_HEADER_PARAM</span> <span class="token operator">=</span> <span class="token string">"X-Authorization"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FORM_BASED_LOGIN_ENTRY_POINT</span> <span class="token operator">=</span> <span class="token string">"/api/auth/login"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOKEN_BASED_AUTH_ENTRY_POINT</span> <span class="token operator">=</span> <span class="token string">"/api/**"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOKEN_REFRESH_ENTRY_POINT</span> <span class="token operator">=</span> <span class="token string">"/api/auth/token"</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">RestAuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">AjaxAuthenticationProvider</span> ajaxAuthenticationProvider<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">JwtAuthenticationProvider</span> jwtAuthenticationProvider<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">TokenExtractor</span> tokenExtractor<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>
        
    <span class="token keyword">protected</span> <span class="token class-name">AjaxLoginProcessingFilter</span> <span class="token function">buildAjaxLoginProcessingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">AjaxLoginProcessingFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AjaxLoginProcessingFilter</span><span class="token punctuation">(</span><span class="token constant">FORM_BASED_LOGIN_ENTRY_POINT</span><span class="token punctuation">,</span> successHandler<span class="token punctuation">,</span> failureHandler<span class="token punctuation">,</span> objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> filter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token class-name">JwtTokenAuthenticationProcessingFilter</span> <span class="token function">buildJwtTokenAuthenticationProcessingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pathsToSkip <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOKEN_REFRESH_ENTRY_POINT</span><span class="token punctuation">,</span> <span class="token constant">FORM_BASED_LOGIN_ENTRY_POINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkipPathRequestMatcher</span> matcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipPathRequestMatcher</span><span class="token punctuation">(</span>pathsToSkip<span class="token punctuation">,</span> <span class="token constant">TOKEN_BASED_AUTH_ENTRY_POINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtTokenAuthenticationProcessingFilter</span> filter 
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenAuthenticationProcessingFilter</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">,</span> tokenExtractor<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> filter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>ajaxAuthenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>jwtAuthenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
        <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// We don't need CSRF for JWT based authentication</span>
        <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">)</span>
        
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token constant">FORM_BASED_LOGIN_ENTRY_POINT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Login end-point</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token constant">TOKEN_REFRESH_ENTRY_POINT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Token refresh end-point</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/console"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// H2 Console Dash-board - only for testing</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token constant">TOKEN_BASED_AUTH_ENTRY_POINT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Protected API End-points</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">buildAjaxLoginProcessingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">buildJwtTokenAuthenticationProcessingFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>PasswordEncoderConfig</h4>
<p>BCrypt encoder that is in AjaxAuthenticationProvider.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordEncoderConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4>BloomFilterTokenVerifier</h4>
<p>This is dummy class. You should ideally implement your own TokenVerifier to check for revoked tokens.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BloomFilterTokenVerifier</span> <span class="token keyword">implements</span> <span class="token class-name">TokenVerifier</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> jti<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 class="f5 lh-copy">Conclusion</h3>
<p>I heard people whispering on the web that loosing a JWT token is like loosing your house keys. So be careful.</p>
<h2 class="f4 lh-copy">References</h2>
<ul>
<li><a href="https://www.dinochiesa.net/?p=1388">I don’t see the point in Revoking or Blacklisting JWT</a></li>
<li><a href="https://github.com/dsyer/spring-security-architecture">Spring Security Architecture - Dave Syer</a></li>
<li><a href="http://stackoverflow.com/questions/21978658/invalidating-json-web-tokens/36884683#36884683">Invalidating JWT</a></li>
<li><a href="http://stackoverflow.com/questions/38557379/secure-and-stateless-jwt-implementation">Secure and stateless JWT implementation</a></li>
<li><a href="https://github.com/dwyl/learn-json-web-tokens">Learn JWT</a></li>
<li><a href="https://www.cloudfoundry.org/opaque-access-tokens-cloud-foundry/">Opaque access tokens and cloud foundry</a></li>
<li><a href="http://by.jtl.xyz/2016/06/the-unspoken-vulnerability-of-jwts.html">The unspoken vulnerability of JWTS</a></li>
<li><a href="http://nordicapis.com/how-to-control-user-identity-within-microservices/">How To Control User Identity Within Micro-services</a></li>
<li><a href="http://stackoverflow.com/questions/3487991/why-does-oauth-v2-have-both-access-and-refresh-tokens/12885823">Why Does OAuth v2 Have Both Access and Refresh Tokens?</a></li>
<li><a href="https://tools.ietf.org/html/rfc6749">RFC-6749</a></li>
<li><a href="https://www.sslvpn.online/are-breaches-of-jwt-based-servers-more-damaging/">Are breaches of JWT-based servers more damaging?</a></li>
</ul>


</article>

</section>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://svlada.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  </main>


<script data-goatcounter="https://svlada.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>


</body></html>